<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="test" basedir="../../../">
	<!-- base dir is repository checkout dir -->

	<description>
		Ant File for JUnit Tests
	</description>

	<property environment="env" />
	<property name="build.path" location="${env.WORKSPACE}/../builds/${env.BUILD_ID}" />
	<property name="workspace" location="${env.WORKSPACE}" />
	<property name="platform" location="/messung/eve/java" />

	<target name="test-compile">
		<delete dir="${env.WORKSPACE}/tests" />
		<mkdir dir="${env.WORKSPACE}/tests" />
		<mkdir dir="${env.WORKSPACE}/tests/bin" />
		<mkdir dir="${env.WORKSPACE}/tests/src" />
		<mkdir dir="${env.WORKSPACE}/tests/build" />
		<mkdir dir="${env.WORKSPACE}/tests/results" />
		<unzip src="${env.WORKSPACE}/bin/eveCSS/eveCSS-linux.gtk.x86_64.zip" 
				dest="${env.WORKSPACE}/tests/bin" />
		<copy todir="${env.WORKSPACE}/tests/src">
			<fileset dir="${env.WORKSPACE}/repo/applications/plugins/org.csstudio.eve.data.tests" />
			<fileset dir="${env.WORKSPACE}/repo/applications/plugins/org.csstudio.eve.util.tests" />
		</copy>
		
		<javac srcdir="${env.WORKSPACE}/tests/src/src"
				destdir="${env.WORKSPACE}/tests/build/"
				source="1.5"
				target="1.5"
				debug="on">
			<classpath>
				<fileset dir="${env.WORKSPACE}/tests/bin">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javac>
	</target>

	<target name="test" depends="test-compile">
		<mkdir dir="${env.WORKSPACE}/tests/doc" />
		
		<junit fork="yes" forkmode="perBatch" haltonfailure="false" failureproperty="failed">
			<classpath>
				<fileset dir="${env.WORKSPACE}/tests/bin/eveCSS">
					<include name="**/*.jar" />
				</fileset>
				<pathelement path="${env.WORKSPACE}/tests/build/" />
				<pathelement
					path="${env.WORKSPACE}/repo/applications/plugins/org.csstudio.eve.util/lib/commons-math3-3.1.1.jar" />
				<pathelement
					path="${env.WORKSPACE}/repo/applications/plugins/org.csstudio.eve.resources/cfg/" />
				<pathelement
					path="${env.WORKSPACE}/repo/applications/plugins/org.csstudio.eve.data/lib/jfxrt.jar" />
			</classpath>

			<formatter type="brief" usefile="false" />
			<formatter type="xml" />

			<batchtest todir="${env.WORKSPACE}/tests/results">
				<fileset dir="${env.WORKSPACE}/tests/src/src">
					<include name="**/*Test.java" />
				</fileset>
			</batchtest>
		</junit>
		<fail message="TEST FAILURE" if="failed" />
	</target>
</project>